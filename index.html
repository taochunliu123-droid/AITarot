<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>PMé‡Œé•·ä¼¯å¡”ç¾…ç‰Œ | PM Mayors Tarot</title>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Noto+Sans+TC:wght@300;400;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.14/vision_bundle.js" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        :root { --cyber-cyan: #00FFFF; --cyber-orange: #FF6B35; --cyber-purple: #9D4EDD; --cyber-gold: #FFD700; --bg-dark: #0a0a0f; --bg-panel: rgba(10, 20, 40, 0.9); }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Noto Sans TC', sans-serif; background: var(--bg-dark); color: var(--cyber-cyan); overflow-x: hidden; min-height: 100vh; }
        @media print { body * { visibility: hidden; } #printArea, #printArea * { visibility: visible; } #printArea { position: absolute; left: 0; top: 0; width: 100%; background: white !important; color: black !important; padding: 30px; } }
        @media (max-width: 768px) { #btnPrint { display: none !important; } }
        .scanlines { position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 1000; background: repeating-linear-gradient(0deg, transparent, transparent 2px, rgba(0,255,255,0.015) 2px, rgba(0,255,255,0.015) 4px); }
        #particleCanvas, #handCanvas { position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; }
        #particleCanvas { z-index: 50; } #handCanvas { z-index: 10; }
        #videoContainer { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1; background: linear-gradient(135deg, #0a0a0f 0%, #1a1a2e 50%, #0f0f1a 100%); }
        #webcam { width: 100%; height: 100%; object-fit: cover; filter: brightness(0.35) contrast(1.2) saturate(0.7); transform: scaleX(-1); display: none; }
        #webcam.active { display: block; }
        .main-container { position: relative; min-height: 100vh; padding: 15px; padding-bottom: 120px; z-index: 20; }
        .header { display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px; margin-bottom: 15px; }
        .logo-section { display: flex; align-items: center; gap: 12px; }
        .logo-container { width: 55px; height: 55px; border-radius: 50%; border: 2px solid var(--cyber-cyan); display: flex; align-items: center; justify-content: center; background: rgba(0, 255, 255, 0.1); animation: logoPulse 2s infinite; flex-shrink: 0; overflow: hidden; }
        .logo-container img { width: 100%; height: 100%; object-fit: cover; }
        .logo-fallback { text-align: center; }
        .logo-fallback .pm { font-family: 'Orbitron'; font-size: 1rem; color: var(--cyber-cyan); }
        .logo-fallback .mayors { font-family: 'Orbitron'; font-size: 0.5rem; color: var(--cyber-orange); }
        @keyframes logoPulse { 0%, 100% { box-shadow: 0 0 10px var(--cyber-cyan); } 50% { box-shadow: 0 0 25px var(--cyber-cyan), 0 0 40px var(--cyber-orange); } }
        .title-section h1 { font-family: 'Orbitron'; font-size: clamp(1rem, 3.5vw, 1.6rem); font-weight: 900; background: linear-gradient(90deg, var(--cyber-cyan), var(--cyber-orange), var(--cyber-purple)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .title-section .subtitle { font-size: 0.65rem; color: var(--cyber-cyan-dim); letter-spacing: 1px; }
        .lang-toggle { display: flex; gap: 5px; }
        .lang-btn { padding: 6px 12px; background: transparent; border: 1px solid var(--cyber-cyan); border-radius: 4px; color: var(--cyber-cyan); font-size: 0.75rem; cursor: pointer; font-family: 'Orbitron'; transition: all 0.3s; }
        .lang-btn.active { background: var(--cyber-cyan); color: #000; }
        .status-bar { display: flex; align-items: center; gap: 15px; flex-wrap: wrap; }
        .time-display { font-family: 'Orbitron'; font-size: 1.1rem; color: var(--cyber-cyan); text-shadow: 0 0 10px var(--cyber-cyan); }
        .hand-indicator { display: flex; align-items: center; gap: 5px; font-size: 0.75rem; }
        .hand-dot { width: 8px; height: 8px; border-radius: 50%; background: #555; transition: all 0.3s; }
        .hand-dot.active { background: #00FF00; box-shadow: 0 0 10px #00FF00; animation: pulse 1s infinite; }
        @keyframes pulse { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.3); } }
        .tarot-section { max-width: 900px; margin: 0 auto; }
        .tarot-header { text-align: center; margin-bottom: 25px; }
        .tarot-header h2 { font-family: 'Orbitron'; font-size: clamp(1.1rem, 3vw, 1.5rem); color: var(--cyber-cyan); margin-bottom: 5px; }
        .tarot-header p { color: #666; font-size: 0.8rem; }
        .card-deck { display: flex; justify-content: center; gap: clamp(10px, 3vw, 20px); margin-bottom: 25px; perspective: 1500px; min-height: 280px; align-items: center; }
        .card-deck.hidden-cards .tarot-card { opacity: 0; transform: translateY(100vh) scale(0.3); pointer-events: none; }
        .tarot-card { width: clamp(90px, 18vw, 140px); height: clamp(150px, 30vw, 240px); position: relative; cursor: pointer; transform-style: preserve-3d; transition: transform 0.8s cubic-bezier(0.4, 0, 0.2, 1), opacity 0.6s ease; opacity: 1; }
        .tarot-card.fly-in { animation: flyIn 0.8s cubic-bezier(0.34, 1.56, 0.64, 1) forwards; }
        @keyframes flyIn { 0% { opacity: 0; transform: translateY(100vh) scale(0.3) rotateZ(20deg); } 60% { opacity: 1; transform: translateY(-30px) scale(1.05) rotateZ(-5deg); } 100% { opacity: 1; transform: translateY(0) scale(1) rotateZ(0deg); } }
        .tarot-card:hover:not(.flipped) { transform: translateY(-10px) rotateY(5deg); }
        .tarot-card.flipped { transform: rotateY(180deg); }
        .tarot-card.shuffling { animation: shuffle 0.6s ease-in-out; }
        @keyframes shuffle { 0% { transform: translateY(0) rotateZ(0) scale(1); } 25% { transform: translateY(-40px) rotateZ(-8deg) scale(1.05); } 50% { transform: translateY(-20px) rotateZ(8deg) scale(1.1); } 75% { transform: translateY(-30px) rotateZ(-4deg) scale(1.05); } 100% { transform: translateY(0) rotateZ(0) scale(1); } }
        .card-face { position: absolute; width: 100%; height: 100%; backface-visibility: hidden; -webkit-backface-visibility: hidden; border-radius: 10px; overflow: hidden; }
        .card-back { background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f0f1a 100%); border: 2px solid var(--cyber-cyan); display: flex; align-items: center; justify-content: center; box-shadow: 0 0 25px var(--cyber-cyan-dim); }
        .card-back::before { content: ''; position: absolute; width: 80%; height: 80%; border: 1px dashed var(--cyber-cyan); border-radius: 8px; animation: rotateFrame 15s linear infinite; }
        @keyframes rotateFrame { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        .card-pattern { font-size: clamp(2rem, 6vw, 3.5rem); color: var(--cyber-cyan); text-shadow: 0 0 25px var(--cyber-cyan); animation: patternPulse 2s infinite; z-index: 1; }
        @keyframes patternPulse { 0%, 100% { opacity: 0.6; transform: scale(1); } 50% { opacity: 1; transform: scale(1.1); } }
        .card-front { background: linear-gradient(180deg, #0f0f1a 0%, #1a1a2e 50%, #0f0f1a 100%); border: 2px solid var(--cyber-gold); transform: rotateY(180deg); padding: 10px; display: flex; flex-direction: column; box-shadow: 0 0 35px rgba(255, 215, 0, 0.4); }
        .card-position { font-family: 'Orbitron'; font-size: 0.65rem; color: var(--cyber-purple); text-align: center; }
        .card-number { font-family: 'Orbitron'; font-size: 0.7rem; color: var(--cyber-gold); text-align: center; margin-top: 2px; }
        .card-image { flex: 1; display: flex; align-items: center; justify-content: center; font-size: 3.5rem; text-shadow: 0 0 25px currentColor; }
        .card-name { text-align: center; margin-top: 5px; }
        .card-name-text { font-family: 'Orbitron'; font-size: 0.85rem; color: var(--cyber-cyan); text-shadow: 0 0 10px var(--cyber-cyan); }
        .card-meaning { font-size: 0.6rem; color: #777; text-align: center; margin-top: 3px; line-height: 1.2; }
        .control-panel { background: var(--bg-panel); border: 1px solid var(--cyber-cyan); border-radius: 10px; padding: 20px; margin-bottom: 25px; backdrop-filter: blur(10px); }
        .control-title { font-family: 'Orbitron'; font-size: 0.9rem; color: var(--cyber-orange); margin-bottom: 12px; display: flex; align-items: center; gap: 8px; }
        .control-title::before { content: 'â–¶'; animation: blink 1s infinite; }
        @keyframes blink { 0%, 100% { opacity: 1; } 50% { opacity: 0.3; } }
        .question-input { width: 100%; padding: 12px; background: rgba(0, 255, 255, 0.05); border: 1px solid var(--cyber-cyan-dim); border-radius: 6px; color: var(--cyber-cyan); margin-bottom: 12px; font-family: 'Noto Sans TC'; }
        .question-input:focus { outline: none; border-color: var(--cyber-cyan); box-shadow: 0 0 20px var(--cyber-cyan-dim); }
        .ai-control { display: flex; align-items: center; margin-bottom: 12px; gap: 10px; padding: 8px; background: rgba(0,255,255,0.05); border-radius: 6px; border: 1px solid rgba(0,255,255,0.2); }
        .toggle-switch { position: relative; display: inline-block; width: 44px; height: 24px; flex-shrink: 0; }
        .toggle-switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #333; transition: .4s; border-radius: 24px; border: 1px solid #555; }
        .slider:before { position: absolute; content: ""; height: 16px; width: 16px; left: 3px; bottom: 3px; background-color: #aaa; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: var(--cyber-purple); border-color: var(--cyber-cyan); }
        input:checked + .slider:before { transform: translateX(20px); background-color: #fff; box-shadow: 0 0 8px #fff; }
        .ai-label { font-size: 0.85rem; color: var(--cyber-cyan); font-family: 'Orbitron'; }
        .btn-group { display: flex; gap: 10px; flex-wrap: wrap; }
        .btn { flex: 1; padding: 14px; background: rgba(0,255,255,0.05); border: 2px solid var(--cyber-cyan); border-radius: 6px; color: var(--cyber-cyan); font-family: 'Orbitron'; cursor: pointer; position: relative; overflow: hidden; transition: all 0.3s; }
        .btn:hover { background: rgba(0,255,255,0.2); box-shadow: 0 0 25px var(--cyber-cyan-dim); transform: translateY(-2px); }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }
        .btn.primary { background: linear-gradient(135deg, rgba(0,255,255,0.15), rgba(157,78,221,0.15)); border-color: var(--cyber-purple); }
        .reading-result { background: var(--bg-panel); border: 1px solid var(--cyber-purple); border-radius: 10px; padding: 20px; display: none; animation: fadeInUp 0.5s ease; backdrop-filter: blur(10px); }
        .reading-result.show { display: block; }
        @keyframes fadeInUp { from { opacity: 0; transform: translateY(25px); } to { opacity: 1; transform: translateY(0); } }
        .reading-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; flex-wrap: wrap; gap: 10px; }
        .reading-title { font-family: 'Orbitron'; color: var(--cyber-purple); }
        .action-buttons { display: flex; gap: 8px; }
        .btn-action { padding: 8px 12px; background: transparent; border: 1px solid var(--cyber-orange); border-radius: 4px; color: var(--cyber-orange); cursor: pointer; display: flex; align-items: center; gap: 4px; }
        .btn-action:hover { background: var(--cyber-orange); color: #000; }
        .btn-action svg { width: 14px; height: 14px; }
        .reading-section { margin-bottom: 15px; padding: 12px; background: rgba(0,255,255,0.03); border-left: 3px solid var(--cyber-cyan); }
        .reading-section h4 { color: var(--cyber-cyan); font-family: 'Orbitron'; margin-bottom: 6px; }
        .reading-section p { color: #aaa; font-size: 0.85rem; line-height: 1.6; }
        .summary-box { background: linear-gradient(135deg, rgba(157,78,221,0.1), rgba(0,255,255,0.1)); border: 1px solid var(--cyber-purple); border-radius: 8px; padding: 15px; margin-top: 15px; }
        .summary-box h4 { color: var(--cyber-gold); font-family: 'Orbitron'; text-align: center; margin-bottom: 10px; }
        .summary-text { text-align: center; color: var(--cyber-cyan); line-height: 1.6; }
        .blink { animation: blinkText 1.5s infinite; }
        @keyframes blinkText { 0%,100% { opacity: 1; } 50% { opacity: 0.5; } }
        #printArea { display: none; }
        #printArea.printing { display: block; position: fixed; top: 0; left: 0; width: 100%; min-height: 100vh; background: white; color: black; padding: 30px; z-index: 10000; overflow: auto; }
        .print-card { border: 2px solid #333; padding: 10px; border-radius: 8px; text-align: center; width: 100px; }
        .print-cards { display: flex; justify-content: center; gap: 10px; margin: 20px 0; }
        .print-section { background: #f5f5f5; padding: 10px; margin: 10px 0; border-radius: 5px; }
        .intro-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--bg-dark); z-index: 9999; display: flex; flex-direction: column; align-items: center; justify-content: center; transition: opacity 0.8s ease; }
        .intro-screen.fade-out { opacity: 0; pointer-events: none; }
        .intro-logo { width: 120px; height: 120px; border-radius: 50%; border: 3px solid var(--cyber-cyan); margin-bottom: 30px; box-shadow: 0 0 30px var(--cyber-cyan-dim); overflow: hidden; animation: logoPulse 2s infinite; }
        .intro-logo img { width: 100%; height: 100%; object-fit: cover; }
        .intro-title { font-family: 'Orbitron'; font-size: 2rem; color: var(--cyber-cyan); margin-bottom: 40px; text-align: center; }
        .intro-btn-group { display: flex; gap: 20px; }
        .intro-btn { padding: 15px 40px; font-size: 1.2rem; background: rgba(0,255,255,0.1); border: 2px solid var(--cyber-cyan); color: var(--cyber-cyan); font-family: 'Orbitron'; cursor: pointer; transition: all 0.3s; border-radius: 8px; }
        .intro-btn:hover { background: var(--cyber-cyan); color: #000; box-shadow: 0 0 20px var(--cyber-cyan); }
        .scan-guide { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 300px; height: 300px; border: 2px dashed rgba(0, 255, 255, 0.3); border-radius: 20px; pointer-events: none; z-index: 15; display: flex; align-items: center; justify-content: center; transition: all 0.5s ease; }
        .scan-guide.hand-found { border-color: var(--cyber-orange); box-shadow: 0 0 30px rgba(255, 107, 53, 0.3); }
        .scan-guide.hidden { opacity: 0; pointer-events: none; }
        .scan-text { color: rgba(0, 255, 255, 0.5); font-family: 'Orbitron'; text-align: center; font-size: 0.9rem; animation: pulseText 2s infinite; }
        @keyframes pulseText { 0%, 100% { opacity: 0.3; } 50% { opacity: 0.8; } }
        .floating-footer { position: fixed; bottom: 0; left: 0; right: 0; background: linear-gradient(180deg, transparent, rgba(10, 10, 15, 0.98) 30%); padding: 15px 15px 12px; z-index: 1000; backdrop-filter: blur(10px); }
        .footer-content { max-width: 900px; margin: 0 auto; display: flex; justify-content: center; align-items: center; gap: 8px; flex-wrap: wrap; text-align: center; }
        .footer-logo { width: 35px; height: 35px; border-radius: 50%; border: 1px solid var(--cyber-cyan); overflow: hidden; flex-shrink: 0; }
        .footer-logo img { width: 100%; height: 100%; object-fit: cover; }
        .footer-text { font-size: 0.75rem; color: rgba(255,255,255,0.7); line-height: 1.4; }
        .footer-text a { color: var(--cyber-orange); text-decoration: none; transition: all 0.3s; }
        .footer-text a:hover { color: var(--cyber-cyan); text-shadow: 0 0 10px var(--cyber-cyan); }
        .footer-divider { color: rgba(255,255,255,0.3); }
        .loading-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--bg-dark); display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 10000; transition: opacity 0.6s ease; }
        .loading-overlay.hidden { opacity: 0; pointer-events: none; }
        .loading-spinner { width: 60px; height: 60px; border: 3px solid var(--cyber-cyan-dim); border-top-color: var(--cyber-cyan); border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .loading-text { font-family: 'Orbitron'; color: var(--cyber-cyan); margin-top: 15px; font-size: 0.85rem; }
        .energy-burst { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 0; height: 0; border-radius: 50%; background: radial-gradient(circle, rgba(0,255,255,0.7) 0%, transparent 70%); pointer-events: none; z-index: 100; opacity: 0; }
        .energy-burst.active { animation: energyBurst 0.8s ease-out forwards; }
        @keyframes energyBurst { 0% { width: 0; height: 0; opacity: 1; } 100% { width: 120vmax; height: 120vmax; opacity: 0; } }
        .toast { position: fixed; bottom: 100px; left: 50%; transform: translateX(-50%) translateY(50px); background: var(--bg-panel); border: 1px solid var(--cyber-cyan); border-radius: 6px; padding: 12px 20px; color: var(--cyber-cyan); font-size: 0.8rem; z-index: 2000; opacity: 0; transition: all 0.3s; backdrop-filter: blur(10px); }
        .toast.show { transform: translateX(-50%) translateY(0); opacity: 1; }
        .corner { position: fixed; width: 40px; height: 40px; border: 2px solid var(--cyber-cyan-dim); pointer-events: none; z-index: 5; }
        .corner.tl { top: 8px; left: 8px; border-right: none; border-bottom: none; }
        .corner.tr { top: 8px; right: 8px; border-left: none; border-bottom: none; }
        .corner.bl { bottom: 80px; left: 8px; border-right: none; border-top: none; }
        .corner.br { bottom: 80px; right: 8px; border-left: none; border-top: none; }
    </style>
</head>
<body>
    <div class="loading-overlay" id="loadingOverlay"><div class="loading-spinner"></div><div class="loading-text" id="loadingText">ç³»çµ±åˆå§‹åŒ–ä¸­...</div></div>
    <div class="intro-screen" id="introScreen" style="display: none;">
        <div class="intro-logo"><img src="./logo.png" alt="Logo" onerror="this.src='data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAxMDAgMTAwIj48Y2lyY2xlIGN4PSI1MCIgY3k9IjUwIiByPSI0NSIgZmlsbD0ibm9uZSIgc3Ryb2tlPSIjMDBGRkZGIiBzdHJva2Utd2lkdGg9IjIiLz48dGV4dCB4PSI1MCIgeT0iNTUiIGZvbnQtZmFtaWx5PSJtb25vc3BhY2UiIGZvbnQtc2l6ZT0iMjAiIGZpbGw9IiMwMEZGRkYiIHRleHQtYW5jaG9yPSJtaWRkbGUiPlBNPC90ZXh0Pjwvc3ZnPg=='"></div>
        <h1 class="intro-title">PM MAYORS TAROT</h1>
        <div class="intro-btn-group"><button class="intro-btn" onclick="startApp('zh')">ä¸­æ–‡</button><button class="intro-btn" onclick="startApp('en')">ENGLISH</button></div>
    </div>
    <div class="scan-guide" id="scanGuide"><div class="scan-text" id="scanText">è«‹å°‡æ‰‹æ”¾å…¥æ¡†å…§<br>ğŸ‘Œ æåˆæ‰‹æŒ‡é–‹å§‹å åœ</div></div>
    <div class="scanlines"></div><canvas id="particleCanvas"></canvas><div class="energy-burst" id="energyBurst"></div>
    <div class="corner tl"></div><div class="corner tr"></div><div class="corner bl"></div><div class="corner br"></div>
    <div id="videoContainer"><video id="webcam" autoplay playsinline muted></video></div><canvas id="handCanvas"></canvas>
    <div class="toast" id="toast"></div>
    <div id="printArea">
        <div class="print-header"><h1 id="printTitle">PMé‡Œé•·ä¼¯å¡”ç¾…ç‰Œ</h1><p id="printDate"></p></div>
        <div id="printQuestion"></div><div class="print-cards" id="printCards"></div><div id="printReadings"></div>
        <div class="print-summary" id="printSummary"></div>
        <div class="print-footer"><p>ğŸ˜ï¸ é‡Œé•·ä¼¯å¹«åŠ©æ‚¨ç”¨AIç©è½‰æ•æ·</p><p>Provided by Tao Chun Liu (PM Mayors)</p><p>linkedin.com/in/taochunliu</p></div>
    </div>
    <div class="main-container" id="mainContent">
        <header class="header">
            <div class="logo-section">
                <div class="logo-container">
                    <img src="./logo.png" alt="PM Mayors" id="logoImg" onerror="this.style.display='none';document.getElementById('logoFallback').style.display='block';">
                    <div class="logo-fallback" id="logoFallback" style="display:none;"><div class="pm">PM</div><div class="mayors">MAYORS</div></div>
                </div>
                <div class="title-section"><h1 id="mainTitle">PMé‡Œé•·ä¼¯å¡”ç¾…ç‰Œ</h1><div class="subtitle">PM MAYORS ALGORITHMIC TAROT</div></div>
            </div>
            <div class="status-bar">
                <div class="lang-toggle"><button class="lang-btn active" id="btnZh" onclick="setLang('zh')">ä¸­æ–‡</button><button class="lang-btn" id="btnEn" onclick="setLang('en')">EN</button></div>
                <div class="time-display" id="currentTime">00:00:00</div>
                <div class="hand-indicator"><span id="handLabel">ğŸ–ï¸</span><div class="hand-dot" id="handDot"></div><span id="handStatus">--</span></div>
            </div>
        </header>
        <section class="tarot-section">
            <div class="tarot-header"><h2 id="tarotTitle">â—ˆ ç®—æ³•å¡”ç¾…å åœ â—ˆ</h2><p id="tarotSubtitle">çµåˆAIé‹ç®—èˆ‡å¤è€æ™ºæ…§çš„æœªä¾†å åœç³»çµ±</p></div>
            <div class="card-deck hidden-cards" id="cardDeck"></div>
            <div class="control-panel">
                <div class="control-title" id="controlTitle">å åœæ§åˆ¶å°</div>
                <div class="ai-control">
                    <label class="toggle-switch"><input type="checkbox" id="aiToggle"><span class="slider"></span></label>
                    <span class="ai-label" id="aiToggleLabel">ğŸ¤– å•Ÿå‹• PMé‡Œé•·ä¼¯ AI è§£è®€ (GPT-4)</span>
                </div>
                <input type="text" class="question-input" id="questionInput" placeholder="è¼¸å…¥æ‚¨çš„å•é¡Œ...">
                <div class="btn-group">
                    <button class="btn primary" id="btnDraw"><span id="btnDrawText">â—† å•Ÿå‹•å¡”ç¾…ç®—æ³• â—†</span></button>
                    <button class="btn" id="btnReset"><span id="btnResetText">é‡ç½®</span></button>
                </div>
            </div>
            <div class="reading-result" id="readingResult">
                <div class="reading-header">
                    <div class="reading-title" id="readingTitle">â—ˆ ç®—æ³•è§£è®€çµæœ</div>
                    <div class="action-buttons">
                        <button class="btn-action" id="btnSaveImage" title="Save Image"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2"/><circle cx="8.5" cy="8.5" r="1.5"/><path d="M21 15l-5-5L5 21"/></svg><span id="btnImageText">åœ–ç‰‡</span></button>
                        <button class="btn-action" id="btnPrint" title="Print PDF"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M6 9V2h12v7"/><path d="M6 18H4a2 2 0 01-2-2v-5a2 2 0 012-2h16a2 2 0 012 2v5a2 2 0 01-2 2h-2"/><rect x="6" y="14" width="12" height="8"/></svg><span id="btnPrintText">PDF</span></button>
                    </div>
                </div>
                <div class="reading-content" id="readingContent"></div>
            </div>
        </section>
    </div>
    <footer class="floating-footer">
        <div class="footer-content">
            <div class="footer-logo"><img src="./logo.png" alt="PM Mayors" onerror="this.parentElement.innerHTML='ğŸ˜ï¸'"></div>
            <div class="footer-text">
                <a href="https://www.linkedin.com/in/taochunliu/" target="_blank" rel="noopener">é‡Œé•·ä¼¯</a>å¹«åŠ©æ‚¨ç”¨AIç©è½‰æ•æ·
                <span class="footer-divider">|</span>
                Provided by <a href="https://www.linkedin.com/in/taochunliu/" target="_blank" rel="noopener">Tao Chun Liu (PM Mayors)</a>
            </div>
        </div>
    </footer>
    <script>
        const i18n = {
            zh: { mainTitle: 'PMé‡Œé•·ä¼¯å¡”ç¾…ç‰Œ', loadingText: 'ç³»çµ±åˆå§‹åŒ–ä¸­...', tarotTitle: 'â—ˆ ç®—æ³•å¡”ç¾…å åœ â—ˆ', tarotSubtitle: 'çµåˆAIé‹ç®—èˆ‡å¤è€æ™ºæ…§çš„æœªä¾†å åœç³»çµ±', controlTitle: 'å åœæ§åˆ¶å°', placeholder: 'è¼¸å…¥æ‚¨çš„å•é¡Œ...', btnDraw: 'â—† å•Ÿå‹•å¡”ç¾…ç®—æ³• â—†', btnReset: 'é‡ç½®', readingTitle: 'â—ˆ ç®—æ³•è§£è®€çµæœ', btnImage: 'åœ–ç‰‡', btnPrint: 'PDF', footerText: 'é‡Œé•·ä¼¯å¹«åŠ©æ‚¨ç”¨AIç©è½‰æ•æ·', handDetected: 'åµæ¸¬ä¸­', handNone: 'ç„¡åµæ¸¬', positions: ['éå»', 'ç¾åœ¨', 'æœªä¾†'], question: 'å•é¡Œ', summary: 'â­ ç¸½çµè§£è®€', awaiting: 'ç­‰å¾…æ­ç¤º', savingImage: 'æ­£åœ¨ç”Ÿæˆåœ–ç‰‡...', pleaseDrawFirst: 'è«‹å…ˆé€²è¡Œå åœ', printTitle: 'PMé‡Œé•·ä¼¯å¡”ç¾…ç‰Œ', aiThinking: 'ğŸ”® é‡Œé•·ä¼¯æ­£åœ¨é€šéˆä¸­...', aiError: 'âš ï¸ AI é€£ç·šå¤±æ•—', aiMode: 'ğŸ¤– å•Ÿå‹• PMé‡Œé•·ä¼¯ AI è§£è®€ (GPT-4)', scanText: 'è«‹å°‡æ‰‹æ”¾å…¥æ¡†å…§<br>ğŸ‘Œ æåˆæ‰‹æŒ‡é–‹å§‹å åœ', handPaused: 'åµæ¸¬æš«åœ' },
            en: { mainTitle: 'PM Mayors Tarot', loadingText: 'Initializing...', tarotTitle: 'â—ˆ Algorithmic Tarot â—ˆ', tarotSubtitle: 'Futuristic divination system', controlTitle: 'Divination Console', placeholder: 'Enter your question...', btnDraw: 'â—† Activate Algorithm â—†', btnReset: 'Reset', readingTitle: 'â—ˆ Reading Results', btnImage: 'Image', btnPrint: 'PDF', footerText: 'PM Mayors helps you master Agile with AI', handDetected: 'Detected', handNone: 'None', positions: ['Past', 'Present', 'Future'], question: 'Question', summary: 'â­ Summary', awaiting: 'Awaiting', savingImage: 'Generating image...', pleaseDrawFirst: 'Please draw cards first', printTitle: 'PM Mayors Tarot', aiThinking: 'ğŸ”® AI is channeling...', aiError: 'âš ï¸ AI Connection Failed', aiMode: 'ğŸ¤– Enable AI Reading (GPT-4)', scanText: 'Place Hand Here<br>ğŸ‘Œ Pinch to Start', handPaused: 'Paused' }
        };
        let currentLang = 'zh';
        const majorArcana = [
            { number: 0, zh: 'æ„šè€…', en: 'The Fool', symbol: 'ğŸƒ', meaningZh: 'æ–°é–‹å§‹ã€å†’éšªã€ç´”çœŸ', meaningEn: 'New beginnings, adventure', color: '#FFD700' }, { number: 1, zh: 'é­”è¡“å¸«', en: 'The Magician', symbol: 'ğŸ©', meaningZh: 'å‰µé€ åŠ›ã€æŠ€èƒ½ã€æ„å¿—', meaningEn: 'Creativity, skill, willpower', color: '#FF6B35' }, { number: 2, zh: 'å¥³ç¥­å¸', en: 'High Priestess', symbol: 'ğŸŒ™', meaningZh: 'ç›´è¦ºã€ç¥ç§˜ã€å…§åœ¨æ™ºæ…§', meaningEn: 'Intuition, mystery', color: '#9D4EDD' }, { number: 3, zh: 'çš‡å', en: 'The Empress', symbol: 'ğŸ‘‘', meaningZh: 'è±ç››ã€æ¯æ€§ã€å‰µé€ ', meaningEn: 'Abundance, fertility', color: '#00FF00' }, { number: 4, zh: 'çš‡å¸', en: 'The Emperor', symbol: 'âš”ï¸', meaningZh: 'æ¬Šå¨ã€çµæ§‹ã€é ˜å°', meaningEn: 'Authority, structure', color: '#FF3366' }, { number: 5, zh: 'æ•™çš‡', en: 'The Hierophant', symbol: 'â›ª', meaningZh: 'å‚³çµ±ã€æŒ‡å°ã€ä¿¡ä»°', meaningEn: 'Tradition, guidance', color: '#00FFFF' }, { number: 6, zh: 'æˆ€äºº', en: 'The Lovers', symbol: 'ğŸ’•', meaningZh: 'æ„›æƒ…ã€é¸æ“‡ã€å’Œè«§', meaningEn: 'Love, choices', color: '#FF69B4' }, { number: 7, zh: 'æˆ°è»Š', en: 'The Chariot', symbol: 'ğŸï¸', meaningZh: 'æ±ºå¿ƒã€å‹åˆ©ã€æ§åˆ¶', meaningEn: 'Determination, victory', color: '#FFA500' }, { number: 8, zh: 'åŠ›é‡', en: 'Strength', symbol: 'ğŸ¦', meaningZh: 'å‹‡æ°£ã€è€å¿ƒã€å…§åœ¨åŠ›é‡', meaningEn: 'Courage, patience', color: '#FFD700' }, { number: 9, zh: 'éš±å£«', en: 'The Hermit', symbol: 'ğŸ”ï¸', meaningZh: 'å…§çœã€å°‹æ±‚ã€æ™ºæ…§', meaningEn: 'Introspection, seeking', color: '#4169E1' }, { number: 10, zh: 'å‘½é‹ä¹‹è¼ª', en: 'Wheel of Fortune', symbol: 'ğŸ¡', meaningZh: 'å‘½é‹ã€è½‰è®Šã€æ©Ÿé‡', meaningEn: 'Destiny, change', color: '#9400D3' }, { number: 11, zh: 'æ­£ç¾©', en: 'Justice', symbol: 'âš–ï¸', meaningZh: 'å…¬å¹³ã€çœŸç›¸ã€å› æœ', meaningEn: 'Fairness, truth', color: '#C0C0C0' }, { number: 12, zh: 'å€’åŠäºº', en: 'The Hanged Man', symbol: 'ğŸ™ƒ', meaningZh: 'çŠ§ç‰²ã€æ–°è¦–è§’ã€ç­‰å¾…', meaningEn: 'Sacrifice, perspective', color: '#4682B4' }, { number: 13, zh: 'æ­»ç¥', en: 'Death', symbol: 'ğŸ’€', meaningZh: 'çµæŸã€è½‰åŒ–ã€é‡ç”Ÿ', meaningEn: 'Endings, transformation', color: '#2F4F4F' }, { number: 14, zh: 'ç¯€åˆ¶', en: 'Temperance', symbol: 'ğŸº', meaningZh: 'å¹³è¡¡ã€è€å¿ƒã€é©åº¦', meaningEn: 'Balance, patience', color: '#20B2AA' }, { number: 15, zh: 'æƒ¡é­”', en: 'The Devil', symbol: 'ğŸ˜ˆ', meaningZh: 'æŸç¸›ã€èª˜æƒ‘ã€é™°æš—é¢', meaningEn: 'Bondage, temptation', color: '#8B0000' }, { number: 16, zh: 'é«˜å¡”', en: 'The Tower', symbol: 'ğŸ—¼', meaningZh: 'çªè®Šã€è¦ºé†’ã€è§£æ”¾', meaningEn: 'Upheaval, awakening', color: '#FF4500' }, { number: 17, zh: 'æ˜Ÿæ˜Ÿ', en: 'The Star', symbol: 'â­', meaningZh: 'å¸Œæœ›ã€éˆæ„Ÿã€å¹³éœ', meaningEn: 'Hope, inspiration', color: '#00CED1' }, { number: 18, zh: 'æœˆäº®', en: 'The Moon', symbol: 'ğŸŒ•', meaningZh: 'å¹»è±¡ã€ç›´è¦ºã€ææ‡¼', meaningEn: 'Illusion, intuition', color: '#E6E6FA' }, { number: 19, zh: 'å¤ªé™½', en: 'The Sun', symbol: 'â˜€ï¸', meaningZh: 'æˆåŠŸã€å–œæ‚…ã€æ´»åŠ›', meaningEn: 'Success, joy', color: '#FFD700' }, { number: 20, zh: 'å¯©åˆ¤', en: 'Judgement', symbol: 'ğŸ“¯', meaningZh: 'è¦ºé†’ã€é‡ç”Ÿã€å¬å–š', meaningEn: 'Awakening, rebirth', color: '#DAA520' }, { number: 21, zh: 'ä¸–ç•Œ', en: 'The World', symbol: 'ğŸŒ', meaningZh: 'å®Œæˆã€æ•´åˆã€æˆå°±', meaningEn: 'Completion, achievement', color: '#00FF7F' }
        ];
        let selectedCards = [], isDrawing = false, particles = [], handLandmarker = null, handDetected = false, handTrackingEnabled = true;

        function setLang(l) { currentLang = l; document.getElementById('btnZh').classList.toggle('active', l==='zh'); document.getElementById('btnEn').classList.toggle('active', l==='en'); updateUI(); if(selectedCards.length) generateReading(); }
        function t(k) { return i18n[currentLang][k]||k; }
        function sleep(ms) { return new Promise(r=>setTimeout(r,ms)); }
        function hexToRgb(h) { const r=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(h); return r?`${parseInt(r[1],16)},${parseInt(r[2],16)},${parseInt(r[3],16)}`:'0,255,255'; }
        function showToast(m) { const x=document.getElementById('toast'); x.textContent=m; x.classList.add('show'); setTimeout(()=>x.classList.remove('show'),2500); }
        function updateUI() {
            ['mainTitle','tarotTitle','tarotSubtitle','controlTitle','btnDrawText','btnResetText','readingTitle','btnImageText','btnPrintText','footerText'].forEach(id=>{ const el=document.getElementById(id); if(el) el.textContent=t(id.replace('Text','').replace('main','main')); });
            document.getElementById('questionInput').placeholder=t('placeholder'); 
            document.getElementById('handStatus').textContent = handTrackingEnabled ? (handDetected?t('handDetected'):t('handNone')) : t('handPaused');
            document.getElementById('aiToggleLabel').textContent = t('aiMode');
            document.getElementById('scanText').innerHTML = t('scanText');
        }

        const particleCanvas=document.getElementById('particleCanvas'), pCtx=particleCanvas.getContext('2d');
        class Particle { constructor(x,y,c){this.x=x;this.y=y;this.color=c;this.size=Math.random()*4+1;this.sx=(Math.random()-0.5)*12;this.sy=(Math.random()-0.5)*12;this.l=1;this.d=Math.random()*0.02+0.01;} update(){this.x+=this.sx;this.y+=this.sy;this.l-=this.d;this.sx*=0.98;this.sy*=0.98;} draw(c){c.beginPath();c.arc(this.x,this.y,this.size*this.l,0,Math.PI*2);c.fillStyle=this.color.replace('1)',`${this.l})`);c.shadowBlur=15;c.shadowColor=this.color;c.fill();c.shadowBlur=0;} }
        function createExplosion(x,y,n=40,c='rgba(0,255,255,1)'){for(let i=0;i<n;i++)particles.push(new Particle(x,y,c));}
        function animateParticles(){pCtx.clearRect(0,0,particleCanvas.width,particleCanvas.height);particles=particles.filter(p=>p.l>0);particles.forEach(p=>{p.update();p.draw(pCtx);});requestAnimationFrame(animateParticles);}
        animateParticles();

        function generateCardDeck() {
            const d=document.getElementById('cardDeck'); d.innerHTML=''; d.classList.add('hidden-cards');
            for(let i=0;i<3;i++) {
                const c=document.createElement('div'); c.className='tarot-card';
                c.innerHTML=`<div class="card-face card-back"><div class="card-pattern">âœ§</div></div><div class="card-face card-front"><div class="card-position">${t('positions')[i]}</div><div class="card-number">--</div><div class="card-image">?</div><div class="card-name"><div class="card-name-text">${t('awaiting')}</div></div><div class="card-meaning">--</div></div>`;
                d.appendChild(c);
            }
        }

        async function drawCards() {
            if(isDrawing) return; isDrawing=true; document.getElementById('btnDraw').disabled=true;
            handTrackingEnabled = false;
            document.getElementById('scanGuide').classList.add('hidden');
            document.getElementById('handStatus').textContent = t('handPaused');
            document.getElementById('handDot').classList.remove('active');
            
            const deck = document.getElementById('cardDeck');
            const cards=document.querySelectorAll('.tarot-card');
            cards.forEach(c=>c.classList.remove('flipped','shuffling','fly-in'));
            document.getElementById('readingResult').classList.remove('show');
            const burst=document.getElementById('energyBurst'); burst.classList.remove('active'); void burst.offsetWidth; burst.classList.add('active');
            createExplosion(window.innerWidth/2,window.innerHeight/2,60,'rgba(157,78,221,1)');
            
            deck.classList.remove('hidden-cards');
            for(let i=0;i<3;i++){ await sleep(200); cards[i].classList.add('fly-in'); }
            await sleep(800);
            cards.forEach(c=>c.classList.remove('fly-in')); // ç§»é™¤ fly-in è®“ transform å¯ä»¥æ­£å¸¸é‹ä½œ
            for(let i=0;i<3;i++){ await sleep(150); cards[i].classList.add('shuffling'); }
            await sleep(600); cards.forEach(c=>c.classList.remove('shuffling'));
            
            const shuffled=[...majorArcana].sort(()=>Math.random()-0.5); selectedCards=shuffled.slice(0,3);
            for(let i=0;i<3;i++){
                await sleep(600); const c=cards[i], d=selectedCards[i], f=c.querySelector('.card-front');
                const name=currentLang==='zh'?d.zh:d.en, meaning=currentLang==='zh'?d.meaningZh:d.meaningEn;
                f.innerHTML=`<div class="card-position">${t('positions')[i]}</div><div class="card-number">#${d.number}</div><div class="card-image" style="color:${d.color}">${d.symbol}</div><div class="card-name"><div class="card-name-text">${name}</div></div><div class="card-meaning">${meaning}</div>`;
                c.classList.add('flipped');
                const r=c.getBoundingClientRect(); createExplosion(r.left+r.width/2,r.top+r.height/2,35,`rgba(${hexToRgb(d.color)},1)`);
            }
            await sleep(800); generateReading(); isDrawing=false; document.getElementById('btnDraw').disabled=false;
        }

        async function generateReading() {
            const q = document.getElementById('questionInput').value || (currentLang==='zh'?'é€šç”¨å åœ':'General Reading');
            const pos = t('positions'); const useAI = document.getElementById('aiToggle').checked;
            let html = `<div class="reading-section"><h4>${t('question')}</h4><p>${q}</p></div>`;
            selectedCards.forEach((c,i)=>{
                const name=currentLang==='zh'?c.zh:c.en, meaning=currentLang==='zh'?c.meaningZh:c.meaningEn;
                let intro = currentLang==='zh' ? [`åœ¨æ‚¨çš„éå¾€ç¶“æ­·ä¸­ï¼Œ${name}ç‰Œçš„å‡ºç¾è±¡å¾µè‘—ã€Œ${meaning}ã€çš„èƒ½é‡ã€‚é€™æ®µç¶“æ­·ç‚ºæ‚¨ç¾åœ¨çš„è™•å¢ƒå¥ å®šäº†åŸºç¤ã€‚`, `æ­¤åˆ»ï¼Œ${name}ç‰Œæ­ç¤ºäº†æ‚¨ç•¶å‰çš„æ ¸å¿ƒèƒ½é‡æ˜¯ã€Œ${meaning}ã€ã€‚é€™æ˜¯ç†è§£æ‚¨ç¾æ³çš„é—œéµè¨Šæ¯ã€‚`, `å±•æœ›æœªä¾†ï¼Œ${name}ç‰Œé ç¤ºè‘—ã€Œ${meaning}ã€çš„èƒ½é‡å³å°‡é€²å…¥æ‚¨çš„ç”Ÿå‘½ã€‚è«‹æ•é–‹å¿ƒæ‰‰è¿æ¥é€™ä»½è½‰è®Šã€‚`][i] : [`In your past, the ${name} card reveals the energy of "${meaning}" has been influencing your journey.`, `Currently, the ${name} card shows your core energy is "${meaning}". This is key to understanding your present.`, `Looking ahead, the ${name} indicates "${meaning}" is about to enter your life. Open your heart to this change.`][i];
                html+=`<div class="reading-section"><h4>${pos[i]} - ${name} ${c.symbol}</h4><p>${intro}</p></div>`;
            });
            html += `<div class="summary-box"><h4>${t('summary')}</h4><p class="summary-text" id="ai-summary">...</p></div>`;
            document.getElementById('readingContent').innerHTML=html;
            document.getElementById('readingResult').classList.add('show');
            const c0=currentLang==='zh'?selectedCards[0].zh:selectedCards[0].en, c1=currentLang==='zh'?selectedCards[1].zh:selectedCards[1].en, c2=currentLang==='zh'?selectedCards[2].zh:selectedCards[2].en;
            let summaryText = currentLang==='zh' ? `ç¶œåˆä¸‰å¼µç‰Œçš„è¨Šæ¯ï¼šå¾ã€Œ${c0}ã€çš„éå¾€ç¶“é©—ï¼Œåˆ°ã€Œ${c1}ã€çš„ç¾æ³è¦ºå¯Ÿï¼Œå†åˆ°ã€Œ${c2}ã€çš„æœªä¾†æŒ‡å¼•ã€‚å‘½é‹çš„ç®—æ³•é¡¯ç¤ºï¼Œæ‚¨æ­£è™•æ–¼é‡è¦çš„äººç”Ÿè½‰æŠ˜é»ã€‚å»ºè­°ä¿æŒé–‹æ”¾çš„å¿ƒæ…‹ï¼Œä¿¡ä»»ç›´è¦ºï¼Œæ“æŠ±å³å°‡åˆ°ä¾†çš„æ”¹è®Šã€‚` : `Synthesizing: from "${c0}" (Past) to "${c1}" (Present) and "${c2}" (Future). The algorithm shows a key turning point. Trust your intuition.`;
            document.getElementById('ai-summary').textContent = summaryText;
            window.currentReading = { question: q, summary: summaryText };
            if(useAI) {
                document.getElementById('ai-summary').innerHTML = `<span class="blink">${t('aiThinking')}</span>`;
                try {
                    const prompt = currentLang === 'zh' ? `å•é¡Œï¼š${q}\nç‰Œé™£ï¼š1.éå»-${c0} 2.ç¾åœ¨-${c1} 3.æœªä¾†-${c2}` : `Question: ${q}\nCards: 1.Past-${c0} 2.Present-${c1} 3.Future-${c2}`;
                    const res = await fetch('/api/tarot', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ prompt }) });
                    if (!res.ok) { const errData = await res.json().catch(() => ({})); throw new Error(errData.error || `Server Error: ${res.status}`); }
                    const data = await res.json();
                    if(data.error) throw new Error(data.error);
                    const aiText = data.choices[0].message.content;
                    document.getElementById('ai-summary').innerHTML = aiText.replace(/\n/g, '<br>');
                    window.currentReading.summary = aiText;
                } catch(e) { console.error(e); document.getElementById('ai-summary').textContent = `${t('aiError')} (${e.message || 'Check Server Logs'})`; }
            }
        }

        function resetCards(){
            selectedCards=[]; generateCardDeck();
            document.getElementById('readingResult').classList.remove('show');
            document.getElementById('questionInput').value='';
            handTrackingEnabled = true;
            document.getElementById('scanGuide').classList.remove('hidden');
            document.getElementById('handStatus').textContent = t('handNone');
        }
        
        async function saveAsImage(){showToast(t('savingImage'));try{const c=await html2canvas(document.getElementById('mainContent'),{backgroundColor:'#0a0a0f',scale:2,useCORS:true,logging:false});const l=document.createElement('a');l.download=`PM-Tarot-${Date.now()}.png`;l.href=c.toDataURL('image/png');document.body.appendChild(l);l.click();document.body.removeChild(l);}catch(e){console.error(e);}}
        function printAsPDF(){if(!window.currentReading){showToast(t('pleaseDrawFirst'));return;}const{question,summary}=window.currentReading;document.getElementById('printDate').textContent=new Date().toLocaleString();document.getElementById('printQuestion').innerHTML=`<p><strong>${t('question')}:</strong> ${question}</p>`;let h='';selectedCards.forEach((c,i)=>{const n=currentLang==='zh'?c.zh:c.en;h+=`<div class="print-card"><div class="pos">${t('positions')[i]}</div><div class="symbol">${c.symbol}</div><div class="name">${n}</div></div>`;});document.getElementById('printCards').innerHTML=h;document.getElementById('printSummary').innerHTML=`<h3>${t('summary')}</h3><p>${summary}</p>`;const a=document.getElementById('printArea');a.classList.add('printing');setTimeout(()=>{window.print();a.classList.remove('printing');},100);}
        function updateTime(){document.getElementById('currentTime').textContent=new Date().toLocaleTimeString('en-US',{hour12:false});}

        async function initHandTracking(){try{const{HandLandmarker,FilesetResolver}=await import('https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.14/+esm');const v=await FilesetResolver.forVisionTasks('https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.14/wasm');handLandmarker=await HandLandmarker.createFromOptions(v,{baseOptions:{modelAssetPath:'https://storage.googleapis.com/mediapipe-models/hand_landmarker/hand_landmarker/float16/1/hand_landmarker.task',delegate:'GPU'},runningMode:'VIDEO',numHands:1,minHandDetectionConfidence:0.5,minHandPresenceConfidence:0.5,minTrackingConfidence:0.5});startHandDetection();}catch(e){console.error(e);}}
        
        function startHandDetection(){
            const v=document.getElementById('webcam'),c=document.getElementById('handCanvas'),ctx=c.getContext('2d');
            c.width=window.innerWidth;c.height=window.innerHeight;
            let last=-1,start=0,hold=false; const DELAY=1000;
            function det(){
                ctx.clearRect(0,0,c.width,c.height);
                if(!handTrackingEnabled){ requestAnimationFrame(det); return; }
                if(v.readyState>=2&&handLandmarker){
                    const n=performance.now();
                    if(n!==last){
                        last=n; const r=handLandmarker.detectForVideo(v,n); const g=document.getElementById('scanGuide');
                        if(r.landmarks.length){
                            handDetected=true; g.classList.add('hand-found');
                            document.getElementById('handDot').classList.add('active');
                            document.getElementById('handStatus').textContent=currentLang==='zh'?"ç­‰å¾…æåˆ":"Wait Pinch";
                            const l=r.landmarks[0]; drawHand(ctx,l,c.width,c.height); check(ctx,l,n);
                        }else{
                            handDetected=false; g.classList.remove('hand-found'); hold=false; start=0;
                            document.getElementById('handDot').classList.remove('active');
                            document.getElementById('handStatus').textContent=t('handNone');
                        }
                    }
                }
                requestAnimationFrame(det);
            }
            function check(x,l,time){
                if(isDrawing){start=0;return;}
                const th=l[4],in_=l[8],sx=(1-th.x)*c.width,sy=th.y*c.height,d=Math.hypot(th.x-in_.x,th.y-in_.y);
                x.save();x.font="16px 'Orbitron'";x.shadowColor="rgba(0,0,0,0.8)";x.shadowBlur=4;
                let txt=currentLang==='zh'?"ğŸ‘Œ æåˆæ‰‹æŒ‡":"ğŸ‘Œ Pinch";x.fillStyle="#00FFFF";
                if(hold){x.fillStyle="#FF6B35";txt=currentLang==='zh'?"â³ ä¿æŒ...":"â³ Hold...";}
                x.fillText(txt,sx+20,sy-20);x.restore();
                if(d<0.06){
                    if(!hold){hold=true;start=time;}
                    const p=Math.min((time-start)/DELAY,1);
                    x.beginPath();x.arc(sx,sy,25,0,Math.PI*2);x.strokeStyle='rgba(0,255,255,0.3)';x.lineWidth=4;x.stroke();
                    x.beginPath();x.arc(sx,sy,25,-Math.PI/2,(-Math.PI/2)+(Math.PI*2*p));x.strokeStyle='#FF6B35';x.lineWidth=5;x.stroke();
                    if(p>=1){showToast(currentLang==='zh'?"ğŸ‘Œ æ‰‹å‹¢ç¢ºèªï¼":"ğŸ‘Œ Confirmed!");drawCards();hold=false;start=0;}
                }else{hold=false;start=0;}
            }
            det();
        }
        function drawHand(x,l,w,h){const cn=[[0,1],[1,2],[2,3],[3,4],[0,5],[5,6],[6,7],[7,8],[0,9],[9,10],[10,11],[11,12],[0,13],[13,14],[14,15],[15,16],[0,17],[17,18],[18,19],[19,20],[5,9],[9,13],[13,17]];x.strokeStyle='rgba(0,255,255,0.8)';x.lineWidth=3;cn.forEach(([i,j])=>{x.beginPath();x.moveTo((1-l[i].x)*w,l[i].y*h);x.lineTo((1-l[j].x)*w,l[j].y*h);x.stroke();});x.fillStyle='rgba(255,107,53,0.9)';l.forEach(p=>{x.beginPath();x.arc((1-p.x)*w,p.y*h,5,0,Math.PI*2);x.fill();});}
        async function initCamera(){try{const s=await navigator.mediaDevices.getUserMedia({video:{facingMode:'user',width:{ideal:1280},height:{ideal:720}}});const v=document.getElementById('webcam');v.srcObject=s;v.classList.add('active');v.onloadedmetadata=()=>{v.play();initHandTracking();};}catch(e){console.log(e);showToast("Camera Error");}}
        function startApp(l){setLang(l);const i=document.getElementById('introScreen');i.classList.add('fade-out');setTimeout(()=>i.style.display='none',800);generateCardDeck();updateTime();setInterval(updateTime,1000);initCamera();}
        document.addEventListener('DOMContentLoaded',()=>{setTimeout(()=>{document.getElementById('loadingOverlay').classList.add('hidden');document.getElementById('introScreen').style.display='flex';},1000);document.getElementById('btnDraw').addEventListener('click',drawCards);document.getElementById('btnReset').addEventListener('click',resetCards);document.getElementById('btnSaveImage').addEventListener('click',saveAsImage);document.getElementById('btnPrint').addEventListener('click',printAsPDF);document.getElementById('questionInput').addEventListener('keypress',(e)=>{if(e.key==='Enter')drawCards();});window.addEventListener('resize',()=>{['particleCanvas','handCanvas'].forEach(id=>{const c=document.getElementById(id);if(c){c.width=window.innerWidth;c.height=window.innerHeight;}});});setInterval(()=>{if(particles.length<15){const p=new Particle(Math.random()*window.innerWidth,Math.random()*window.innerHeight,'rgba(0,255,255,0.4)');p.sx=(Math.random()-0.5);p.sy=(Math.random()-0.5);p.d=0.003;particles.push(p);}},400);});
    </script>
</body>
</html>
